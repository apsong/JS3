#! /bin/sh

PROGRAM=`basename $0`
AZKABAN=`dirname $0/Azkaban`

RUNTIME=~/.Azkaban
RC_FILE=$RUNTIME/initrc
mkdir -p $RUNTIME
[ -f $RC_FILE ] && . $RC_FILE
[ -n "$AZKABAN_URL" ] && URL=$AZKABAN_URL
[ -n "$AZKABAN_PROJECT" ] && PROJECT=$AZKABAN_PROJECT
################################################################################
#0:DEBUG  1:INFO  2:WARN  3:ERROR
logLEVEL=2
logDEBUG()
{
    [ $logLEVEL -le 0 ] && echo 1>&2 "DEBUG:" "$@"
}
logINFO()
{
    [ $logLEVEL -le 1 ] && echo 1>&2 "INFO: " "$@"
}
logERROR()
{
    [ $logLEVEL -le 3 ] && echo 1>&2 "ERROR:" "$@"
}

EVAL()
{
    echo "#!CMD:[" $@ "]"
    eval "$@"
}
################################################################################
usage()
{
    echo 1>&2 "Usage:"
    {
        echo "    Azkaban project.create [URL] -p PROJECT [-d DESCRIPTION]"
        echo "    Azkaban project.delete [URL] -p PROJECT"
        echo "    Azkaban project.list   [URL]"
        echo "    Azkaban project.upload [URL] -p PROJECT -z ZIP"
        echo "    Azkaban project.Flows  [URL] -p PROJECT [--raw]"
        echo "    Azkaban flow.execute    [URL] -p PROJECT -f FLOW [--wait] [flow.num.job.threads=1]"
        #echo "    Azkaban flow.Executing  [URL] -p PROJECT -f FLOW"
        echo "    Azkaban flow.Executions [URL] -p PROJECT -f FLOW [-o OFFSET] [-l LENGTH] [--raw]"
        echo "    Azkaban flow.Jobs       [URL] -p PROJECT -f FLOW [--raw]"
        echo "    Azkaban flow.schedule   [URL] -p PROJECT -f FLOW [-D yyyymmdd] [-T HH:MM:SS] [-R n{M|w|d|h|m|s}]"
        echo "    Azkaban exec.cancel  [URL] -e EXECID"
        echo "    Azkaban exec.wait    [URL] -e EXECID"
        #echo "    Azkaban exec.pause   [URL] -e EXECID"
        #echo "    Azkaban exec.resume  [URL] -e EXECID"
        echo "    Azkaban exec.Status  [URL] -e EXECID [--raw]"
        echo "    Azkaban exec.Logs    [URL] -e EXECID [-j JOB] [-o OFFSET] [-l LENGTH] [--raw]"
        #echo "    Azkaban exec.Updates [URL] -e EXECID [-t LAST_UPDATE_TIME]"
        echo "    Azkaban schedule.list   [URL]"
        echo "    Azkaban schedule.cancel [URL] -s SCHEDULE_ID"
        echo "    Azkaban session.reinit [URL]"
    } | grep "$CMD" 1>&2
    echo 1>&2 ""
    echo 1>&2 "Note:"
    echo 1>&2 " 1. Defaults would be read from $RC_FILE first"
    echo 1>&2 ' 2. URL: default to $AZKABAN_URL, or "http://localhost:8081"'
}
################################################################################
getSessionID()
{
    ID_FILE=$RUNTIME/session_id.`echo $URL | sed -e 's@/@@g'`
    [ "$1" = "--reinit" ] && > $ID_FILE
    if [ -f $ID_FILE ]; then
        lastmod_seconds=`stat -c %Y $ID_FILE`
        current_sedonds=`date +%s`
        passed_hours=`expr \( $current_sedonds - $lastmod_seconds + 1 \) / 3600`
        if [ "$passed_hours" -ge 12 ]; then
            logINFO "Obsolete the old session_id in $ID_FILE"
            > $ID_FILE
        else
            session_id=`cat $ID_FILE`
            if [ -n "$session_id" ]; then
                logINFO "Get session_id $session_id from $ID_FILE"
                echo $session_id
                return 0
            fi
        fi
    fi
    session_id=`$CURL -X POST -d "action=login&username=system&password=manage" $URL \
                | awk -F\" '/session.id/{print $4}'`
    [ -z "$session_id" ] && { logERROR "Failed to get session_id"; return 1;}
    logINFO "Get session_id $session_id through authentication"
    echo $session_id | tee $ID_FILE
    return 0
}
### Pre Main ###################################################################
case "$PROGRAM" in
    Azkaban) CMD=$1; shift;;
    Azkaban.*) CMD=`echo $PROGRAM | sed -e 's/Azkaban\.//'`;;
    *) logERROR "Invalid PROGRAM '$PROGRAM'"; exit 1;;
esac

case "$CMD" in
    --help) CMD=""; usage; exit 0;;
    --mklinks)
        cd `dirname $0`
        for CMD in project.{create,delete,list,upload,Flows} \
                   flow.{execute,Jobs,Executions,schedule} \
                   exec.{wait,cancel,Status,Logs} \
                   schedule.{list,cancel} \
                   session.reinit; do
            ln -sfv Azkaban Azkaban.$CMD
        done; exit 0;;
esac

### Main #######################################################################

# Input arguments
while [ $# -gt 0 ]; do
    case "$1" in
        http*) URL=$1;;
        -p) shift; PROJECT=$1;;
        -d) shift; DESCRIPTION=$1;;
        -z) shift; ZIP=$1;;
        -f) shift; FLOW=$1;;
        -e) shift; EXECID=$1;;
        -j) shift; JOB=$1;;
        -o) shift; OFFSET=$1;;
        -l) shift; LENGTH=$1;;
        -t) shift; LAST_UPDATE_TIME=$1;;
        -s) shift; SCHEDULE_ID=$1;;
        -D) shift; SCHEDULE_DATE=$1;;
        -T) shift; SCHEDULE_TIME=$1;;
        -R) shift; SCHEDULE_RECUR=$1;;
        *=*) OPTIONS="$OPTIONS $1";;
        --wait) IS_WAIT="YES";;
        --raw)  IS_RAW="YES";;
        --debug) logLEVEL=0;;
        --info)  logLEVEL=1;;
        --warn)  logLEVEL=2;;
        --error) logLEVEL=3;;
        --help) usage; exit 0;;
        --savedefault) IS_SAVE_DEFAULT=YES;;
        *) logERROR "Invalid parameter '$1'"; usage; exit 1;;
    esac
    shift
done
export logLEVEL
[ $logLEVEL -eq 0 ] && CURL="curl -v -ksS" || CURL="curl -ksS"

[ -z "$URL" ] && URL="http://localhost:8081"
if [ "$IS_SAVE_DEFAULT" = "YES" ]; then
    [ "$URL" != "http://localhost:8081" ] && echo "URL=$URL" >> $RC_FILE
    [ "$PROJECT" != "" ] && echo "PROJECT=$PROJECT" >> $RC_FILE
fi
logINFO "URL=$URL"
SESSION_ID=`getSessionID` || exit 2

OUTFILE=$RUNTIME/$CMD.out
case "$CMD" in
    session.reinit)
        getSessionID --reinit ;;
    project.create)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$DESCRIPTION" ] && DESCRIPTION=.
        $CURL -X POST -d "session.id=$SESSION_ID&name=$PROJECT&description=$DESCRIPTION" \
            "$URL/manager?action=create"
        echo ;;
    project.delete)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&project=$PROJECT" \
            "$URL/manager?delete=true"
        ;;
    project.list)
        $CURL -G -d "session.id=$SESSION_ID" "$URL/index?all" \
            | awk '/project=|project-last-modified/{print gensub("<[^>]*>", "", "g")}' \
            | awk '{name=$1; getline; printf("%-20s %s %s\n", name, $4, $5)}' | sort -b -k 2
        ;;
    project.upload)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$ZIP" ] && { logERROR "ZIP must be set"; usage; exit 2;}
        if [ -d "$ZIP" ]; then
            ZIP_DIR=`dirname $ZIP`; ZIP_NAME=`basename $ZIP`
            EVAL "cd $ZIP_DIR; rm -f $ZIP_NAME.zip; zip -r $ZIP_NAME.zip $ZIP_NAME"
            ZIP=$ZIP_DIR/$ZIP_NAME.zip
        fi
        [ ! -f "$ZIP" ] && { logERROR "ZIP '$ZIP' doesn't exit as a normal file"; exit 3;}
        $CURL -X POST -H "Content-Type: multipart/mixed" \
            --form "session.id=$SESSION_ID" --form "ajax=upload" \
            --form "project=$PROJECT;type=plain" --form "file=@$ZIP;type=application/zip" \
            "$URL/manager"
        echo ;;
    project.Flows)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        OUTSTR=`$CURL -G -d "session.id=$SESSION_ID&project=$PROJECT" \
                "$URL/manager?ajax=fetchprojectflows"`
        if [ "$IS_RAW" = "YES" ]; then
            echo "$OUTSTR"
        else
            echo "$OUTSTR" | awk -F\" '{if ($2=="flowId") print $4}'
        fi ;;
    flow.Jobs)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$FLOW" ] && { logERROR "FLOW must be set"; usage; exit 2;}
        OUTSTR=`$CURL -G -d "session.id=$SESSION_ID&project=$PROJECT&flow=$FLOW" \
                "$URL/manager?ajax=fetchflowgraph"`
        if [ "$IS_RAW" = "YES" ]; then
            echo "$OUTSTR"
        else
            echo "$OUTSTR" | awk -F: '
            BEGIN { id=""; IN="" }
            {
                key=gensub(/[\" ]/, "", "g", $1)
                val=gensub(/[\"\[\] ]|,$/, "", "g", $2)
                if (key == "id") { id=val }
                else if (key == "type") { type=val }
                else if (key == "in") { IN = val }
                if ($0 ~ /}/ && id != "") {
                    if (IN == "") { ready[id]=1; print id }
                    else { dependencies[id] = "," IN "," }
                    id=""; IN=""
                }
            } END {
                indent="  "
                while (length(dependencies) > 0) {
                    for (ready_id in ready) {
                        for (id in dependencies) {
                            gsub("," ready_id ",", ",", dependencies[id])
                            if (dependencies[id] == ",") {
                                ready[id]=1; print indent id
                                delete dependencies[id]
                            }
                        }
                    }
                    indent = indent "  "
                }
            }'
        fi ;;
    flow.Executions)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$FLOW" ] && { logERROR "FLOW must be set"; usage; exit 2;}
        [ -z "$OFFSET" ] && OFFSET=0
        [ -z "$LENGTH" ] && LENGTH=100
        OUTSTR=`$CURL -G -d "project=$PROJECT&flow=$FLOW&start=$OFFSET&length=$LENGTH" \
            "$URL/manager?ajax=fetchFlowExecutions&session.id=$SESSION_ID"`
        if [ "$IS_RAW" = "YES" ]; then
            echo "$OUTSTR"
        else
            echo "$OUTSTR" | awk '
            BEGIN {
                print "EXECID  START              END                STATUS     DURATION"
                print "------  -----------------  -----------------  ---------  --------"
            }
            {
                key=gensub(/[\",]/, "", "g", $1)
                val=gensub(/[\",]/, "", "g", $3)
                if (key=="execId") {
                    execId=val
                } else if (key=="startTime") {
                    start=val
                } else if (key=="endTime") {
                    end=val
                } else if (key=="status") {
                    status=val
                } else if ($0 ~ /}.*,/) {
                    if (start>0&&end>0) d=strftime("%H:%M:%S", (end-start)/1000, 1); else d="N/A"
                    if (start>0) start=strftime("%Y%m%d-%H:%M:%S", start/1000); else start="N/A"
                    if (end>0) end=strftime("%Y%m%d-%H:%M:%S", end/1000); else end="N/A"
                    printf("%6d  %-17s  %-17s  %-9s  %-8s\n", execId, start, end, status, d)
                } else if (key=="total") {
                    printf("(total: %d)\n", val)
                }
            }'
        fi
        echo ;;
    flow.Executing)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$FLOW" ] && { logERROR "FLOW must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&project=$PROJECT&flow=$FLOW" \
            "$URL/executor?ajax=getRunning"
        echo ;;
    flow.execute)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$FLOW" ] && { logERROR "FLOW must be set"; usage; exit 2;}
        for OPTION in $OPTIONS; do
            PAIR=`echo $OPTION | awk -F= '{printf("&flowOverride[%s]=%s\n", $1, $2)}'`
            PAIRS="$PAIRS$PAIR"
        done
        OUTSTR=`$CURL -G -d "session.id=$SESSION_ID&project=$PROJECT&flow=$FLOW&$PAIRS" \
                "$URL/executor?ajax=executeFlow"`
        echo "$OUTSTR"
        if [ "$IS_WAIT" = "YES" ]; then
            EXECID=`echo "$OUTSTR" | awk '/"execid"/{print $3}'`
            exec $AZKABAN exec.wait -e $EXECID
        fi ;;
    flow.schedule)
        [ -z "$PROJECT" ] && { logERROR "PROJECT must be set"; usage; exit 2;}
        [ -z "$FLOW" ] && { logERROR "FLOW must be set"; usage; exit 2;}
        PROJECT_ID=`$CURL -G "$URL/manager?session.id=$SESSION_ID&project=$PROJECT" \
                    | awk '/projectId.*=/{print gensub(";", "", "g", $NF)}'`
        [ -z "$PROJECT_ID" ] && { echo 1>&2 "Error: failed to get PROJECT_ID for '$PROJECT'"; exit 1;}
        [ -z "$SCHEDULE_TIME" ] && SCHEDULE_TIME="+1minute"
        [ -z "$SCHEDULE_DATE" ] && SCHEDULE_DATE=`date +"%Y%m%d"`
        SCHEDULE_TIME=`date -d "$SCHEDULE_TIME" +"%H,%M,%p,%Z"`
        SCHEDULE_DATE=`date -d "$SCHEDULE_DATE" +"%m/%d/%Y"`
        [ -n "$SCHEDULE_RECUR" ] && SCHEDULE_RECUR="&is_recurring=on&period=$SCHEDULE_RECUR"
        for OPTION in $OPTIONS; do
            PAIR=`echo $OPTION | awk -F= '{printf("&flowOverride[%s]=%s\n", $1, $2)}'`
            PAIRS="$PAIRS$PAIR"
        done
        $CURL -G -d "project=$PROJECT&projectName=$PROJECT&projectId=$PROJECT_ID&flow=$FLOW&$PAIRS" \
                -d "scheduleTime=$SCHEDULE_TIME&scheduleDate=$SCHEDULE_DATE$SCHEDULE_RECUR" \
                "$URL/schedule?ajax=scheduleFlow&session.id=$SESSION_ID"
        ;;
    exec.cancel)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&execid=$EXECID" \
            "$URL/executor?ajax=cancelFlow"
        echo ;;
    exec.pause)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&execid=$EXECID" \
            "$URL/executor?ajax=pauseFlow"
        echo ;;
    exec.resume)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&execid=$EXECID" \
            "$URL/executor?ajax=resumeFlow"
        echo ;;
    exec.wait)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        while [ 1 ]; do
            OUTSTR=`$AZKABAN exec.Status -e $EXECID`
            status=`echo "$OUTSTR" | awk '/^\[SUMMARY\]/{print $5}'`
            case "$status" in
                *ING)   logDEBUG "$status - sleep 10 to check again"; sleep 10;;
                SUCCEEDED) logDEBUG "$status - exit 0"; echo $status; exit 0;;
                *) logDEBUG "$status - exit 1"; echo $status; exit 1;;
            esac
        done ;;
    exec.Status)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        $CURL -G -d "session.id=$SESSION_ID&execid=$EXECID" \
                "$URL/executor?ajax=fetchexecflow" >$OUTFILE
        if [ "$IS_RAW" = "YES" ]; then
            cat $OUTFILE
            echo
        else
            cat $OUTFILE | awk '
            function NextRecord(INDENT,  id,type,start,end,status)
            {
                while (1) {
                    if ($1~/}/) {
                        if (start>0&&end>0) d=strftime("%H:%M:%S", (end-start)/1000, 1); else d="N/A"
                        if (start>0) start=strftime("%Y%m%d-%H:%M:%S", start/1000); else start="N/A"
                        if (end>0) end=strftime("%Y%m%d-%H:%M:%S", end/1000); else end="N/A"
                        printf("%-32s  %-15s  %-17s  %-17s  %-9s  %-8s\n", id, type, start, end, status, d)
                        $1=""; return
                    }
                    while ($NF=="{") { getline; NextRecord(INDENT+2); }

                    key=gensub(/[\",]/, "", "g", $1)
                    val=gensub(/[\",]/, "", "g", $3)
                    if (key=="id") {
                        id=sprintf("%" INDENT "s%s", "", val)
                    } else if (key=="type") {
                        type=val
                    } else if (key=="startTime") {
                        start=val
                    } else if (key=="endTime") {
                        end=val
                    } else if (key=="status") {
                        status=val
                    }
                    if (!getline) { return }
                }
            }
            BEGIN {
                print "JOB                               TYPE             START              END                STATUS     DURATION"
                print "--------------------------------  ---------------  -----------------  -----------------  ---------  --------"
                NextRecord(-2)
            } {} END {}'
        fi;;
    exec.Logs)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        [ -z "$OFFSET" ] && OFFSET=0
        [ -z "$LENGTH" ] && LENGTH=50000
        if [ -n "$JOB" ]; then
            OUTSTR=`$CURL -G -d "session.id=$SESSION_ID&execid=$EXECID&offset=$OFFSET&length=$LENGTH" \
                    "$URL/executor?ajax=fetchExecJobLogs&jobId=$JOB"`
        else
            OUTSTR=`$CURL -G -d "session.id=$SESSION_ID&execid=$EXECID&offset=$OFFSET&length=$LENGTH" \
                    "$URL/executor?ajax=fetchExecFlowLogs"`
        fi
        if [ "$IS_RAW" = "YES" ]; then
            echo "$OUTSTR"
        else
            echo "$OUTSTR" | awk '/"data" :/{
                n=split(substr($0, 13, length($0)-14), logs, /\\n/)
                for (i=1; i<=n; i++) { print logs[i] }
            }'
        fi ;;
    exec.Updates)
        [ -z "$EXECID" ] && { logERROR "EXECID must be set"; usage; exit 2;}
        [ -z "$LAST_UPDATE_TIME" ] && LAST_UPDATE_TIME=-1
        $CURL -G -d "session.id=$SESSION_ID&execid=$EXECID&lastUpdateTime=$LAST_UPDATE_TIME" \
            "$URL/executor?ajax=fetchexecflowupdate"
        echo ;;
    schedule.list)
        $CURL -G -d "session.id=$SESSION_ID" "$URL/schedule" \
        | awk '/<td>[^<]+<\/td>|project=.*flow=/ {print gensub(/.*<td>|<\/td>.*|.*project=|">.*/, "", "g")}' \
        | awk 'BEGIN {
                print "SCHEDULE_ID  PROJECT.FLOW     USER    FirstSched      NextExec  RepeatsEvery"
                print "-----------  ------------  -------  ------------  ------------  ------------"
               }{
                 id=$0; getline; pf=gensub("&flow=", ".", "g"); getline; user=$0; getline;
                 first=gensub(/^..|-/, "", "g", $1) "-" gensub(/:..$/, "", "g", $2); getline;
                 _next=gensub(/^..|-/, "", "g", $1) "-" gensub(/:..$/, "", "g", $2); getline;
                 repeat=$0; getline; hasSLA=$0;
                 printf("%-3s %21s %8s  %s  %s  %12s\n", id, pf, user, first, _next, repeat);
               }'
        ;;
    schedule.cancel)
        [ -z "$SCHEDULE_ID" ] && { logERROR "SCHEDULE_ID must be set"; usage; exit 2;}
        $CURL -X POST -d "session.id=$SESSION_ID&scheduleId=$SCHEDULE_ID" \
            "$URL/schedule?action=removeSched"
        ;;
    *) logERROR "Invalid sub command '$CMD'"; CMD=""; usage; exit 1;;
esac
